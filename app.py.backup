import os
from datetime import datetime
from flask import Flask, request, render_template_string, redirect, url_for, flash

UPLOAD_FOLDER = '/var/www/uploads'
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['MAX_CONTENT_LENGTH'] = 10 * 1024 * 1024 # 10 MB filesize limit
app.secret_key = 'xK6D4T69EAudenfpXwfX'  # any random string

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

HTML = """
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- mobile friendly [web:5] -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: 600;
    }
    input[type="text"], textarea, input[type="file"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      width: 100%;
      padding: 0.7rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
    }
    .flash {
      margin-bottom: 1rem;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      background: #e0f2fe;
      color: #075985;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Submit Info</h1>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for msg in messages %}
          <div class="flash">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <form method="post" enctype="multipart/form-data">
      <label for="text">Text</label>
      <textarea id="text" name="text" rows="3" required></textarea>

      <label for="photo">Photo</label>
      <input id="photo" type="file" name="photo" accept="image/*" required>

      <button type="submit">Submit</button>
    </form>
  </div>
</body>
</html>
"""

@app.route("/", methods=["GET", "POST"])
def index():
    if request.method == "POST":
        text = request.form.get("text", "").strip()
        file = request.files.get("photo")

        if not text:
            flash("Text is required.")
            return redirect(url_for("index"))

        if not file or file.filename == "":
            flash("Photo is required.")
            return redirect(url_for("index"))

        if not allowed_file(file.filename):
            flash("Only png, jpg, jpeg, gif files are allowed.")
            return redirect(url_for("index"))

        # simple unique name: timestamp + original
        ts = datetime.utcnow().strftime("%Y%m%d-%H%M%S-%f")
        ext = file.filename.rsplit('.', 1)[1].lower()
        #new_name = f"{uuid.uuid4().hex}.{ext}"
        safe_name = f"{ts}.{ext}"
        save_path = os.path.join(app.config["UPLOAD_FOLDER"], safe_name)
        file.save(save_path)

        # TODO: persist text + filename somewhere (db, log file, etc.)
        flash("Upload received. Thanks!")
        return redirect(url_for("index"))

    return render_template_string(HTML)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8008)
